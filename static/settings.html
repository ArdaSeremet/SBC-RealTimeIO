<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>GPIO Settings</title>
	<link rel="stylesheet" href="css/base.css">
</head>
<body>
	<h1 class="settings-header">GPIO Configuration Panel</h1>	

	<script src="js/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		let ioData;
		var socket;
		function getConfiguration() {
			socket = io.connect();
			socket.emit('ioRequest');
			socket.on('gpioData', (data) => {
				ioData = data;
				drawData(ioData);
			});
		}

		function drawData(data) {
			let html = `
			${data.pinOrder.map((item, i) => `
			${(data.controllable_pins[item] != '0') ? `
			<div class="pin">
				<span>${data.pinNames[item]}</span>
				<input min="0" data-gpio-number="${item}" value="${data.timeouts[item] || '0'}" type="number" />
				<select data-gpio-number="${item}">
					<option data-mode="${(data.controllable_pins[item] == '2') ? 'monostable' : 'bistable'}" data-gpio-number="${item}" selected>${(data.controllable_pins[item] == '2') ? 'Monostable(Timer Mode)' : 'Bistable(ON-OFF Mode)'}</option>
					<option data-mode="${(data.controllable_pins[item] == '2') ? 'bistable' : 'monostable'}" data-gpio-number="${item}">${(data.controllable_pins[item] == '2') ? 'Bistable(ON-OFF Mode)' : 'Monostable(Timer Mode)'}</option>
				</select>
			</div>
			` : '' }
			`.trim()).join('')}
<hr>
			${data.pinOrder.map((item, i) => `

				${(data.controllable_pins[item] == '0') ? `

			<div class="pin">
				<span>${data.pinNames[item]}</span>
				<select data-gpio-number="${item}">
					<option data-link-to="unlink" ${(!(item in data.links)) ? 'selected' : ''} data-gpio-number="${item}">Independent Pin</option>
					${data.pinOrder.map((_item, _i) => `

					${(data.controllable_pins[_item] != '0') ? `

					<option data-link-to="${_item}" data-gpio-number="${item}" ${(item in data.links) ? (data.links[item] == _item) ? 'selected' : '' : ''}>Linked to '${data.pinNames[_item]}'</option>					

					`: ''}					

					`.trim()).join('')}
				</select>
			</div>

				` : ''}

				`.trim()).join('')}
			`;
			$('body').append(html);
			for(let [pin, mode] of Object.entries(data.controllable_pins)) {
				if(mode != '0') {
					let selectElement = $("select[data-gpio-number='"+pin+"']");
					selectElement.on('change', (e) => {
						changeMode(pin, selectElement.children('option:selected').attr('data-mode'));
					});
				} else {
					let selectElement = $("select[data-gpio-number='"+pin+"']");
					selectElement.on('change', (e) => {
						let input = selectElement.children('option:selected').attr('data-gpio-number');
						let output = selectElement.children('option:selected').attr('data-link-to');
						if(data.controllable_pins[input] == '0') {
							if(output == 'unlink') {
								unlinkPin(input);
							} else if(output in ioData.controllable_pins && ioData.controllable_pins != '0') {
								linkToInput(input, output);
							}
						}
					});
				}
			
			}
		}
		function linkToInput(input, output) {
			if(input in ioData.controllable_pins && output in ioData.controllable_pins && ioData.controllable_pins[input] == '0' && ioData.controllable_pins[output] != '0') {
				socket.emit('linkToInput', {'input': input, 'output': output});
			}else{
				alert('There is an error with your inputs.');
				return false;
			}
		}

		function unlinkPin(pin) {
			if(pin in ioData.controllable_pins && (pin in ioData.links || Object.values(ioData.links).includes(pin))) {
				socket.emit('unlinkPin', {'pin': pin});
			} else {
				alert('There is an error with your input.');
				return false;
			}
		}
		function changeMode(pin, mode) {
			if(pin in ioData.controllable_pins && (mode == 'bistable' || mode == 'monostable')) {
				let modeCode = (mode == 'bistable') ? '1' : '2';
				let timeout = $("input[data-gpio-number="+pin+"]").val();
				console.log(timeout);
				if(modeCode == '1') { socket.emit('bistableRequest', {'pin': pin}); } else {
					socket.emit('monostableRequest', {'pin': pin, 'timeout': timeout});
				}
			}
		}
		$(() => {
			getConfiguration();
			setInterval(getLinkedPin, 2000);
			setInterval(getUnlinkedPin, 2000);
		});
	</script>
</body>
</html>
